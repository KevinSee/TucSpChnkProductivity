---
title: "Examination of Selected Factors Affecting Survival and Productivity of Tucannon River Spring Chinook Salmon and Implications for the Future"
author:
  - Michael Gallinat:
      email: Michael.Gallinat@dfw.wa.gov
      institute: [wdfw]
      correspondence: true
  - Kevin See:
      email: Kevin.See@dfw.wa.gov
      institute: [wdfw]
      correspondence: false
institute:
  - wdfw: Washington Department of Fish & Wildlife
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
    bookdown::html_document2:
      fig_caption: yes
      fig_height: 5
      fig_width: 6
      toc: yes
      toc_depth: 3
      toc_float:
        collapsed: yes
        smooth_scroll: yes
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
    bookdown::pdf_document2:
      fig_caption: yes
      fig_height: 5
      fig_width: 6
      toc: yes
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
    bookdown::word_document2:
      fig_caption: yes
      fig_height: 6
      fig_width: 6
      toc: yes
      reference_docx: "../templates/WDFW Report Template.docx" # Insert path for the DOCX file
      always_allow_html: true
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography:
  # - AUC.bib
  - references.bib
csl: "../templates/american-fisheries-society.csl" # Insert path for the bib-style
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  # echo = TRUE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 600
)
```

```{r packages}
# load these packages
library(tidyverse)
library(here)
library(readxl)
library(janitor)
library(corrr)
library(mgcv)
library(broom)
library(tidygam)
library(gratia)
library(boot)
library(colorspace)
library(ggpubr)
library(kableExtra)

# set default plotting theme
# theme_set(theme_bw())

theme_set(theme_pubr(#base_family = "Times New Roman",
                     base_size = 12,
                     legend = "bottom"))

# theme_set(theme_pubr())

# knitr options
options(knitr.kable.NA = '-')

# when knitting to Word, use this
# change all `kbl()` to `kable()`
# what kind of document is being created?
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to')

if(!is.null(doc.type)) {
  if(doc.type == 'docx') {
    options(knitr.table.format = "pandoc")
  }
}

```

```{r read-in-data}
#-----------------------------------------------------------------
# read in data
# excel_sheets("data/TucannonSGS.xlsx")

# redd data
redd_df <- tibble(year = 1985:2022) |>
  mutate(data = map(year,
                    .f = function(yr) {
                      col_nms <- c("date",
                                   "survey",
                                   "rkm",
                                   "site",
                                   "stream_section",
                                   "km",
                                   "redds",
                                   "redd_per_km",
                                   "live",
                                   "dead_H",
                                   "dead_W")
                      
                      df <- 
                        read_excel(here("analysis",
                                        "data",
                                        "raw_data",
                                        "TucannonSGS.xlsx"),
                                   sheet = as.character(yr),
                                   skip = 2) |>
                        suppressMessages() |>
                        clean_names()
                      
                      names(df)[c(1:length(col_nms))] <- col_nms
                      
                      df <- 
                        df |>
                        mutate(across(c(site),
                                      ~ as.character(.)),
                               across(c(survey,
                                        redds),
                                      ~ as.numeric(.)))
                      
                      if(class(df$date)[1] == "character") {
                        df <- 
                          df |>
                          mutate(across(date,
                                        ~ excel_numeric_to_date(as.numeric(.))))
                      }
                      if(year(df$date[1]) != yr) {
                        year(df$date) <- yr
                      }
                      
                      df <- 
                        df |>
                        filter(!is.na(site))
                      
                      df <- 
                        df |>
                        select(date:redd_per_km)
                      
                      return(df)
                    })) |>
  unnest(data) |>
  mutate(max_rkm = str_split(rkm, "-", simplify = T)[,1],
         min_rkm = str_split(rkm, "-", simplify = T)[,2],
         across(max_rkm,
                ~ str_remove(., "^\\(")),
         across(min_rkm,
                ~ str_remove(., "\\)$")),
         across(c(min_rkm,
                  max_rkm),
                ~ as.numeric(.)),
         mean_rkm = (min_rkm + max_rkm) / 2)

# other model data
mod_df <- 
  read_excel(here("analysis",
                  "data",
                  "raw_data",
                  "Updated Gallinat Tucannon Spring Chinook Productivity Data.xlsx"),
             2,
             skip = 5,
             col_names = c("trap_type",
                           "brood_yr",
                           "emigration_yr",
                           "number_smolts",
                           "mean_smolt_length",
                           "number_redds",
                           "smolts_redd",
                           "escapement",
                           "spawners",
                           "smolts_spawner",
                           paste0("phos", 
                                 c("_100", "", "_arcsin")),
                           paste("stray", 
                                 c("prop_100", "prop", "prop_arcsin"), 
                                 sep = "_"),
                           paste("redds_wilderness", 
                                 c("prop_100", "prop", "prop_arcsin"), 
                                 sep = "_"),
                           paste("redds_marengo", 
                                 c("prop_100", "prop", "prop_arcsin"), 
                                 sep = "_"),
                           paste("above_trap", 
                                 c("prop_100", "prop", "prop_arcsin"), 
                                 sep = "_"),
                           paste("below_trap", 
                                 c("prop_100", "prop", "prop_arcsin"), 
                                 sep = "_"),
                           paste0("sar_w_jacks", 
                                 c("_100", "", "_arcsin")),
                           paste0("sar_wo_jacks", 
                                 c("_100", "", "_arcsin")),
                           "total_rps",
                           "total_rps_ln",
                           "adult_rps",
                           "adult_rps_ln",
                           "brood_yr2")) |>
  mutate(across(c(brood_yr:adult_rps_ln),
                as.numeric)) %>%
  filter(!is.na(trap_type)) |> 
  mutate(across(brood_yr,
                as.numeric),
         across(phos,
                ~ if_else(phos_100 == 0 & is.na(.), 
                          0, .)),
         across(brood_yr,
                ~ if_else(. > 50, 
                          . + 1900,
                          . + 2000)))
```

```{r model-data}
#-----------------------------------------------------------------
# data for model
ind_redd <-
  redd_df |>
  mutate(ind_redds = map(redds,
                         .f = function(x) {
                           tibble(cnted = rep(T, x))
                         })) |>
  unnest(ind_redds)

# calculate the mean RKM each year
redd_rkm_summ <- 
  ind_redd |> 
  group_by(year) |>
  summarize(redds = n(),
            across(mean_rkm,
                   list(mean_rkm = ~ mean(.),
                        median_rkm = ~ median(.),
                        sd_rkm = ~ sd(.),
                        quant_20 = ~ quantile(., 0.2),
                        quant_80 = ~ quantile(., 0.8)),
                   .names = "{.fn}"),
            .groups = "drop")


mod_df <- 
  mod_df |> 
  left_join(redd_rkm_summ |>
              rename(brood_yr = year),
            by = join_by(brood_yr))


# for the smolt/redd model
mod_df_1 <- mod_df %>%
  # filter(trap_type == "Screw Trap") |>
  # filter(brood_yr >= 2000) |> 
  select(brood_yr,
         emigration_yr,
         smolts = number_smolts,
         redds = number_redds,
         smolts_redd,
         stray_prop,
         phos,
         escapement,
         ends_with("rkm")) %>%
  na.omit() |>
  # mutate(lag_escp = lag(escapement)) |>
  mutate(smolts_redd = smolts/ redds) |>
  relocate(redds,
           .after = smolts_redd)

# z-score all covariates
mod_df_1_z <- 
  mod_df_1 |>
  mutate(across(-c(brood_yr:smolts_redd),
                ~ scale(.) |> 
                  map_dbl(.f = identity)))

# for the SAR and returns/spawner models
mod_df_2 <- mod_df %>%
  select(brood_yr,
         emigration_yr,
         number_smolts,
         starts_with("sar"),
         total_rps,
         adult_rps,
         redds = number_redds,
         spawners,
         phos,
         stray_prop,
         mean_smolt_length,
         ends_with("rkm")) %>%
  na.omit()


mod_df_2 <-
  mod_df_2 |> 
  select(-ends_with("_100"),
         -ends_with("arcsin")) |> 
  mutate(suc_w_jacks = number_smolts * sar_w_jacks,
         suc_wo_jacks = number_smolts * sar_wo_jacks,
         across(starts_with("suc_w"),
                round_half_up),
         across(starts_with("suc_w"),
                as.integer))

# z-scale the covariates
mod_df_2_z <- 
  mod_df_2 |> 
  mutate(across(c(phos,
                  # brood_yr,
                  mean_smolt_length),
                ~ scale(.)))

```

# Introduction

The goals of this work are to:

1. Examine several covariates to determine if they help explain fluctuations in Tucannon Spring Chinook productivity as measured in smolts/redd. These possible covariates include:

* the total number of redds each brood year,
* pHOS, 
* proportion of strays, 
* the mean river kilometer of the redd distribution that year, 
* the standard deviation of the redd river kilometer and 
* the year of smolt emigration.

2. Determine if smolt size (e.g. mean fork length) or pHOS has an impact on various recruitment metrics such as:

* total (ages 3-5) SAR,
* adult (ages 4-5) SAR, 
* returns per spawner,

while accounting for possible effects of brood year.

```{r prelim-ts, fig.height = 8, fig.cap = "Time-series plots showing redds (A), smolts (B), smolts / redd (C), pHOS (D) and the proportion of out-of-basin strays in the Tucanon watershed through time."}
ea_p1 <-
  mod_df |> 
  ggplot(aes(x = brood_yr,
             y = number_redds)) +
  geom_point() +
  geom_line()  +
  labs(x = "Brood year",
       y = "Redds")

ea_p2 <-
  mod_df |> 
  ggplot(aes(x = brood_yr,
             y = number_smolts)) +
  geom_point() +
  geom_line()  +
  scale_y_continuous(labels = scales::label_comma()) +
  labs(x = "Brood year",
       y = "Smolts")

ea_p3 <-
  mod_df |> 
  ggplot(aes(x = brood_yr,
             y = smolts_redd)) +
  geom_point() +
  geom_line()  +
  labs(x = "Brood year",
       y = "Smolts / Redd")


ea_p4 <-
  mod_df |> 
  ggplot(aes(x = brood_yr,
             y = phos)) +
  geom_point() +
  geom_line()  +
  labs(x = "Brood year",
       y = "pHOS")

ea_p5 <-
  mod_df |> 
  ggplot(aes(x = brood_yr,
             y = stray_prop)) +
  geom_point() +
  geom_line()  +
  labs(x = "Brood year",
       y = "Proportion Strays")

ea_p6 <-
  mod_df |> 
  ggplot(aes(x = brood_yr,
             y = total_rps)) +
  geom_line() +
  geom_point(aes(color = phos),
             size = 3) +
  scale_color_continuous_sequential("Hawaii",
                                    name = "pHOS") +
  geom_hline(yintercept = 2,
             linetype = 2,
             color = "gray") +
  # scale_y_continuous(trans = "log",
  #                    breaks = scales::breaks_pretty()) +
  labs(x = "Brood year",
       y = "Total Returns / Spawner")

ea_p7 <-
  mod_df |> 
  ggplot(aes(x = brood_yr,
             y = mean_rkm)) +
  geom_line() +
  geom_point(aes(color = phos),
             size = 3) +
  scale_color_continuous_sequential("Hawaii",
                                    name = "pHOS") +
  geom_hline(yintercept = 59,
             linetype = 2,
             color = "gray") +
  labs(x = "Brood year",
       y = "Mean Redd RKM")



ggarrange(ea_p1 +
            theme(axis.title.x = element_blank()),
          ea_p2 +
            theme(axis.title.x = element_blank()),
          ea_p3 +
            theme(axis.title.x = element_blank()),
          ea_p4 +
            theme(axis.title.x = element_blank()),
          ea_p5 +
            theme(axis.title.x = element_blank()),
          labels = "AUTO",
          nrow = 5,
          ncol = 1) |> 
  annotate_figure(bottom = "Brood Year")
```

# Methods - Data Analysis

## Covariates

We investigated the influence of hatchery-origin spawners on smolts per redd by using the proportion of hatchery origin spawners (pHOS) as a covariate.  In addition, we examined the potential effect of out-of-basin hatchery strays to explore the possibility that out-of-basin hatchery fish could have a different impact on smolts per redd than the integrated hatchery fish of the Tucannon program.  Because pHOS and the proportion of out-of-basin hatchery strays are correlated ($r$ = `r round(cor(mod_df$phos, mod_df$stray_prop), 2)`, Table \@ref(tab:correlations)), instead of using both covariates independently, we included pHOS as a covariate, and the interaction between pHOS and the proportion of strays.  This interaction represents the difference between Tucannon hatchery origin spawners and out-of-basin hatchery origin spawners.

Differences in local rearing habitat within the Tucannon may also contribute to differences in smolts per redd because of how redds can be distributed across the watershed. The hatchery weir on the Tucannon is located at rkm 59, and may impact adult passage through delays, etc. [@Wilson2024].  The habitat in the upper watershed is more pristine while the habitat in the lower watershed is more heavily impacted.  Because many summary statistics describing these phenomenon (e.g., proportion of redds above/below the weir, proportion in the upper watershed, proportion in the lower watershed, etc.) are highly correlated, we chose to examine the mean rkm of the redds each year as a singular covariate that describes many of these general patterns.  We hypothesize that the greater the mean redd rkm (i.e., due to more redds higher in the watershed, towards better habitat and above the weir), the greater smolts per redd will be observed.  We also included as a covariate the standard deviation of the redd rkms, as a measure of how concentrated (small value) or dispersed (high value) the redds were within the watershed in a given year.

```{r correlations, eval = T}
# correlations between covariates?
corr_df <-
  mod_df_1 |>
  select(-escapement) |> 
  select(-c(brood_yr:smolts_redd)) |>
  select(-median_rkm) |> 
  correlate() %>%
  stretch(na.rm = T,
          remove.dups = T) |>
  arrange(desc(abs(r)))

corr_df |> 
  kbl(digits = 3,
      booktabs = T,
      caption = "Pearson correlation coefficient between all pairs of covariates.") |> 
  kable_styling()
```

## Statistical Models

To examine the effects of these covariates on smolts per redd, we fit a generalized additive model (GAM), using the log of smolts per redd as the dependent variable, and spline terms for mean rkm of redds, standard deviation of rkm per redds, pHOS, and emigration year. The inclusion of emigration year helps to control for long-term trends and effects that are not accounted for by the other covariates. We used a GAM to allow for the possibility of non-linear relationships between the independent variables and productivity. We also included two fixed terms: the number of redds and an interaction between pHOS and the proportion of out-of-basin strays. The inclusion of redds as a fixed term assumes a linear relationship between the log of smolts per redd and the total number of redds, which implies a Ricker-like carrying capacity. We made this choice because every ecological system is subject to some carrying capacity constraints [@Chapman2018], and the linearized Ricker model is a common and easily implemented method to incorporate that, while allowing us to allocate more degrees of freedom to the splines of the other covariates.

We also examined the effects of mean smolt length and pHOS on productivity by fitting another series of GAMs using SARs and R/S as the dependent variables, using both total returns (Age 3+) and adults only (Age 4+), for a total of four models. We included splines for the covariates of the mean smolt length of each brood year and pHOS, as well as brood year. The SAR models were fit using a quasibinomial GAM with a logit link function because the SARs are proportions, whereas for both R/S models, we used a linear GAM with a log link function and also included spawners as a linear parametric covariate, to make these two models linearized Ricker models.

Our goal with these analyses is to examine general patterns of how a few covariates affect the population’s productivity, not necessarily test hypotheses or predict future productivity. The dataset has `r nrow(mod_df_1)` data points; therefore, we limited the number of knots in all splines to a maximum of four for all covariates except emigration or brood year, which we allowed to be larger as that term was meant to capture any other processes and long-term trends. We fit a spline for year, rather than treating year as a random effect, because we expected the effects to be auto-correlated and to capture any long-term trend. The model was fit using R statistical software version 4.3.2 (R Core Team 2023) with the mgcv package, using restricted maximum likelihood methods. We checked the effective degrees of freedom in each model fit using the “k.check()” function to ensure against underfitting, while the use of penalized splines guarded against overfitting. Data and code to reproduce this analysis is available on a GitHub repository ***(insert link here)***. 

```{r fit-model-1}
# fit GAM 
gam_mod_1 <- 
  gam(log(smolts_redd) ~
        redds +
        s(mean_rkm, k = 4, bs = "tp", m = 2) +
        s(sd_rkm, k = 4, bs = "tp", m = 2) +
        s(phos, k = 4, bs = "tp", m = 2) +
        phos:stray_prop +
        s(emigration_yr, k = 15, bs = "tp"),
      na.action = na.fail,
      data = mod_df_1,
      method = "REML")
```


```{r, eval = F, echo = F}
summary(gam_mod_1)
# gam.check(gam_mod_1)
k.check(gam_mod_1)
appraise(gam_mod_1)
draw(gam_mod_1,
     residuals = T,
     parametric = T,
     scales = "fixed")

# plot(gam_mod_1,
#      trans = exp,
#      rug = T,
#      shade = T,
#      seWithMean = TRUE,
#      shift = coef(gam_mod_1)[1],
#      ylab = "Smolts / Spawner",
#      residuals = T,
#      ylim = c(0, 600),
#      pch = 1,
#      cex = 1)
```

```{r smolt-capacity}
# Ricker parameter estimates (R ~ alpha * S * exp(-b * S), a = log(alpha))
# carrying capacity of redds
b = as.numeric(coef(gam_mod_1)["redds"])
k = -1 / b
# k
# intrinsic rate of productivity
a = as.numeric(coef(gam_mod_1)["(Intercept)"])
alpha = exp(a)

# r_max = alpha
# r_max
# maximum yield of smolts at carrying capacity
smolt_capacity <-
  tidygam::predict_gam(gam_mod_1,
                       values = list(redds = seq(0, k + 200, by = 1)),
                       series = "redds",
                       tran_fun = exp) |> 
  mutate(smolts = smolts_redd * redds,
         across(ends_with("ci"),
                ~ . * redds)) |> 
  filter(redds <= k) |> 
  slice_max(smolts)
# smolt_capacity
```

```{r fit-model-2}
# fit GAMs
# model formula (to be fairly consistent)
init_form <-
  formula(cbind(suc_w_jacks,
                number_smolts - suc_w_jacks) ~
            s(mean_smolt_length, k = 4, bs = "tp", m = 2) +
            s(phos, k = 4, bs = "tp", m = 2) +
            s(brood_yr, k = 20, bs = "tp"))


gam_mod_2a <-
  gam(init_form,
      # family = binomial,
      family = quasibinomial(link = "logit"),
      data = mod_df_2,
      method = "REML")

gam_mod_2b <-
  gam(update(init_form,
       cbind(suc_wo_jacks,
            number_smolts - suc_wo_jacks) ~ .),
      # family = binomial,
      family = quasibinomial(link = "logit"),
      data = mod_df_2,
      method = "REML")

gam_mod_2c <-
  gam(update(init_form,
       log(total_rps) ~ spawners + .),
      data = mod_df_2,
      method = "REML")

gam_mod_2d <-
  gam(update(init_form,
       log(adult_rps) ~ spawners + .),
      data = mod_df_2,
      method = "REML")
```

```{r, eval = F, echo = F}
all_mods <-
  tibble(num = 1:4,
         mod = list(gam_mod_2a,
                    gam_mod_2b,
                    gam_mod_2c,
                    gam_mod_2d))

i = 3
mod <-
  all_mods |> 
  pull(mod) |> 
  pluck(i)

# gam.check(mod)
k.check(mod)
summary(mod)
appraise(mod)
draw(mod,
     residuals = T,
     parametric = T,
     scales = "fixed")



# plot(mod,
#      # trans = inv.logit,
#      trans = exp,
#      rug = T,
#      shade = T,
#      seWithMean = TRUE,
#      shift = coef(mod)[1],
#      ylab = "SAR",
#      residuals = T,
#      pch = 1,
#      cex = 1)

# any underfitting? 
tibble(name = c("Smolts Per Redd",
                "Total SAR",
                "Adult SAR",
                "Total Returns Per Spawner",
                "Adult Returns Per Spawner"),
       mod = list(gam_mod_1,
                  gam_mod_2a,
                  gam_mod_2b,
                  gam_mod_2c,
                  gam_mod_2d)) |> 
  mutate(diag = map(mod,
                    .f = function(x) {
                      k.check(x) |> 
                        as_tibble(rownames = "covar")
                      })) |> 
  select(-mod) |> 
  unnest(c(diag)) |>
  clean_names() |> 
  arrange(p_value)
  # filter(p_value < 0.4)
```

```{r}
b = c("total" = as.numeric(coef(gam_mod_2c)["spawners"]),
      "adult" = as.numeric(coef(gam_mod_2d)["spawners"]))
K = -1 / b
# K
# intrinsic rate of productivity
a = c("total" = as.numeric(coef(gam_mod_2c)["(Intercept)"]),
      "adult" = as.numeric(coef(gam_mod_2d)["(Intercept)"]))
alpha = exp(a)

# r_max = alpha
# r_max
# maximum yield of returning adults at carrying capacity
ret_capacity <-
  tidygam::predict_gam(gam_mod_2c,
                       values = list(spawners = seq(0, max(K) + 200, by = 1)),
                       series = "spawners",
                       tran_fun = exp) |> 
  mutate(returns = total_rps * spawners,
         across(ends_with("ci"),
                ~ . * spawners)) |> 
  filter(spawners <= K["total"]) |> 
  slice_max(returns) |> 
  add_column(model = "total",
             .before = 0) |> 
  bind_rows(tidygam::predict_gam(gam_mod_2d,
                                 values = list(spawners = seq(0, max(K) + 200, by = 1)),
                                 series = "spawners",
                                 tran_fun = exp) |> 
              mutate(returns = adult_rps * spawners,
                     across(ends_with("ci"),
                            ~ . * spawners)) |> 
              filter(spawners <= K["adult"]) |> 
              slice_max(returns) |> 
              add_column(model = "adult",
                         .before = 0))

```

# Results

Diagnostic checks for all models were sufficient to ensure we did not underfit any models by overly restricting the number of knots in the various splines. The summary statistics for each model, including the pseudo-$R^2$ value and the percent of deviance explained by each model are provided in Table \@ref(tab:r2-tab). All models had fairly high pseudo-$R^2$ values (range of 0.61 – 0.87) and explained a high proportion of the variance (75-91%). To examine the results of the GAMs, we plotted the marginal smoothing plots of each covariate to display how the model predictions change as each covariate shifts, holding the others at a constant value. 

```{r r2-tab, eval = T}
tibble(name = c("Smolts Per Redd",
                "Total SAR",
                "Adult SAR",
                "Total Returns Per Spawner",
                "Adult Returns Per Spawner"),
       mod = list(gam_mod_1,
                  gam_mod_2a,
                  gam_mod_2b,
                  gam_mod_2c,
                  gam_mod_2d)) |> 
  mutate(r2 = map_dbl(mod,
                      .f = function(x) {
                        summary(x)$r.sq
                      }),
         dev_expl = map_dbl(mod,
                            .f = function(x) {
                              summary(x)$dev.expl
                            })) |> 
  select(-mod) |> 
  kbl(col.names = c("Model",
                    "R.sq",
                    "Dev. Explained"),
      digits = 3,
      booktabs = T,
      caption = "Table of summary statistics for each GAM.") |> 
  kable_styling(latex_options = c("HOLD_position"))
```

## Smolts Per Redd

Table \@ref(tab:sr-coef) shows the estimates of parametric coefficients (intercept, slope of linearized Ricker model and the interaction between pHOS and the proportion of out-of-basin strays), while Table \@ref(tab:sr-edf) shows the estimated effective degrees of freedom (edf) of each covariate, and the p-value associated with it. An edf of one is equivalent to a linear function, an edf of two is equivalent of a quadratic function, and higher edfs correspond to more complex functions. Redds had a negative effect on smolts / redd, indicating there is a density dependent effect within this system. The interaction between pHOS and out-of-basin stray proportion was estimated to be negative, but not statistically significant.

```{r sr-coef, eval = T}
broom::tidy(gam_mod_1,
            parametric = T,
            conf.int = T) |> 
  clean_names("title") |> 
  kbl(digits = 3,
      booktabs = T,
      caption = "Parametric coefficient estimates for the smolts per redd GAM from the Tucannon River spring Chinook Salmon analysis.") |> 
  kable_styling()
```

```{r sr-edf, eval = T}
broom::tidy(gam_mod_1) |> 
  clean_names("title") |> 
  kbl(digits = 3,
      booktabs = T,
      caption = "Effective degrees of freedom (EDF) and statistical significance tests for smoother terms in the smolts per redd GAM from the Tucannon River spring Chinook analysis.") |> 
  kable_styling()
```

```{r make-plots}
p1 <-
  predict_gam(gam_mod_1,
              values = list(redds = seq(0, k + 200, by = 1)),
              series = "redds",
              tran_fun = exp) |> 
  mutate(smolts = smolts_redd * redds,
         across(ends_with("ci"),
                ~ . * redds)) |> 
  ggplot(aes(x = redds,
             y = smolts)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              fill = "lightgray",
              alpha = 0.5) +
  geom_line() +
  geom_rug(data = mod_df_1,
           aes(y = NULL)) +
  geom_vline(xintercept = smolt_capacity$redds,
             color = "gray20",
             linetype = 2) +
  # geom_hline(yintercept = smolt_capacity$smolts,
  #            color = "blue",
  #            linetype = 3) +
  scale_y_continuous(labels = scales::label_comma()) +
  labs(y = "Smolts",
       x = "Redds")


p1a <-
  predict_gam(gam_mod_1,
              length_out = 50,
              values = list(redds = seq(0, 800, by = 5)),
              series = "redds",
              tran_fun = exp) |> 
  ggplot(aes(x = redds,
             y = smolts_redd)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              fill = "lightgray",
              alpha = 0.5) +
  geom_line() +
  geom_rug(data = mod_df_1,
           aes(y = NULL)) +
  scale_y_continuous(labels = scales::label_comma(),
                     transform = "log") +
  labs(y = "Smolts / Redd",
       x = "Redds")

p2 <-
  predict_gam(gam_mod_1,
              length_out = 50,
              series = "phos",
              tran_fun = exp) |> 
  ggplot(aes(x = phos,
             y = smolts_redd)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              fill = "lightgray",
              alpha = 0.5) +
  geom_line() +
  geom_rug(data = mod_df_1,
           aes(y = NULL)) +
  scale_y_continuous(labels = scales::label_comma(),
                     transform = "log") +
  labs(y = "Smolts / Redd",
       x = "pHOS")

p3 <-
  predict_gam(gam_mod_1,
              length_out = 50,
              series = "mean_rkm",
              tran_fun = exp) |> 
  ggplot(aes(x = mean_rkm,
             y = smolts_redd)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              fill = "lightgray",
              alpha = 0.5) +
  geom_line() +
  geom_rug(data = mod_df_1,
           aes(y = NULL)) +
  scale_y_continuous(labels = scales::label_comma(),
                     transform = "log") +
  labs(y = "Smolts / Redd",
       x = "Mean redd RKM") +
  # geom_vline(xintercept = 40,
  #            color = "gray20",
  #            linetype = 2) +
  # geom_vline(xintercept = 74,
  #            color = "gray20",
  #            linetype = 2) +
  geom_vline(xintercept = 59,
             color = "gray20",
             linetype = 2)


p4 <-
  predict_gam(gam_mod_1,
              length_out = 50,
              series = "sd_rkm",
              tran_fun = exp) |> 
  ggplot(aes(x = sd_rkm,
             y = smolts_redd)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              fill = "lightgray",
              alpha = 0.5) +
  geom_line() +
  geom_rug(data = mod_df_1,
           aes(y = NULL)) +
  scale_y_continuous(labels = scales::label_comma(),
                     transform = "log") +
  labs(y = "Smolts / Redd",
       x = "SD redd RKM")

p5 <-
  predict_gam(gam_mod_1,
              # length_out = 29,
              values = list(emigration_yr = mod_df_1$emigration_yr),
              series = "emigration_yr",
              tran_fun = exp) |> 
  ggplot(aes(x = emigration_yr,
             y = smolts_redd)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              fill = "lightgray",
              alpha = 0.5) +
  geom_line() +
  # geom_rug(data = mod_df_1,
  #          aes(y = NULL)) +
  # geom_point(data = mod_df_1,
  #            shape = 1) +
  # geom_hline(yintercept = mean(mod_df_1$smolts_redd),
  #            linetype = 2,
  #            color = "red") +
  # coord_cartesian(ylim = c(0, 800)) +
  scale_y_continuous(labels = scales::label_comma(),
                     transform = "log") +
  labs(y = "Smolts / Redd",
       x = "Emigration Year")

p6 <-
  predict_gam(gam_mod_1,
              length_out = 50,
              series = "phos",
              values = list(stray_prop = c(0, 0.05, 0.1, 0.2, 0.4)),
              tran_fun = exp) |> 
  mutate(across(stray_prop,
                as.factor)) |> 
  ggplot(aes(x = phos,
             y = smolts_redd,
             color = stray_prop,
             fill = stray_prop)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              # fill = "lightgray",
              color = NA,
              alpha = 0.2) +
  geom_line(linewidth = 1) +
  geom_rug(data = mod_df_1,
           aes(y = NULL,
               color = NULL,
               fill = NULL)) +
  scale_y_continuous(labels = scales::label_comma(),
                     transform = "log") +
  scale_color_discrete_sequential(palette = "Viridis",
                                 name = "Stray\nProp.",
                                 guide = guide_legend(nrow = 2)) +
  scale_fill_discrete_sequential(palette = "Viridis",
                                 name = "Stray\nProp.",
                                 guide = guide_legend(nrow = 2)) +
  # theme(legend.position = "right") +
  labs(y = "Smolts / Redd",
       x = "pHOS")

```

Figure \@ref(fig:prod-marg) shows the marginal effects of each covariate on predicted smolts per redd, assuming the others are fixed at their mean values. Although the mean redd rkm showed little effect, the smoothed spline of the standard deviation of redd rkm suggest that higher standard deviations (i.e., more dispersed redds) leads to higher predicted values of smolts per redd.  The effect of pHOS suggests that higher levels of pHOS are associated with higher productivity, although when hatchery origin spawners are made up of a higher proportion of out-of-basin strays, that effect is dampened. The estimated smolt capacity, based on the fitted Ricker curve (Figure \@ref(fig:prod-marg)A) is `r prettyNum(round(smolt_capacity$smolts), big.mark = ",")` smolts, which occurs when there are `r round(smolt_capacity$redds)` redds in the system.


```{r prod-marg, fig.height=7, fig.cap = "Predicted marginal effects of each covariate in the smolts/redd GAM (other covariates are fixed at mean values). Plots B-F have log-transformed the y-axis to improve visability. A shows the effect of redds on smolts, B shows the effect of the mean redd river kilometer, C shows the effect of the standard deviation of redd river kilometer, D shows the trend associated with emigration year, and E shows the effect of pHOS and proportion of out-of-basin stray hatchery fish. Gray ribbons depict 95% confidence intervals, while tick marks along the x-axis depict the observed values. The vertical dashed line in A represents the estimated value of redds that lead to the maximum number of smolts. The vertical dashed line in B represents the location of the weir."}

bottom_rows <-
  ggarrange(p3 +
              theme(axis.title.y = element_blank()), 
            p4 +
              theme(axis.title.y = element_blank()), 
            p5 +
              theme(axis.title.y = element_blank()), 
            p6 +
              theme(axis.title.y = element_blank()),
            nrow = 2,
            ncol = 2,
            label.x = 0.15,
            labels = c("B", "C", "D", "E")) |> 
  annotate_figure(left = text_grob("Smolts / Redd", rot = 90))

ggarrange(p1,
          bottom_rows,
          label.x = 0.1,
          labels = c("A", NULL),
          ncol = 1,
          heights = c(1,2))

```


## SAR and Returns/Spawner

For the R/S models, Table \@ref(tab:rec-spwn-coeff) shows the parameter estimates of the intercept and slope that are part of the linearized Ricker model. For both total and adult R/S, spawners had a statistically negative effect, indicating the presence of density dependence sometime between the egg and spawner lifestage. The estimated edf of each covariate for both SAR and R/S models, and the P-values associated with it are found in Table \@ref(tab:edf-coef). The mean smolt length was statistically significant in the SAR models, but not the R/S models. We found that pHOS was not statistically significant in any model, while the brood year spline was significant in all models.

```{r rec-spwn-coeff, eval = T}
broom::tidy(gam_mod_2c,
            parametric = T,
            conf.int = T) |> 
  add_column(model = 'Total',
             .before = 0) |> 
  bind_rows(broom::tidy(gam_mod_2d,
                        parametric = T,
                        conf.int = T) |> 
              add_column(model = 'Adult',
                         .before = 0)) |> 
  clean_names("title") |> 
  kbl(digits = 3,
      booktabs = T,
      caption = "Coefficient estimates of fixed effects for both total and adult only returns per spawner GAMs from the Tucannon River spring Chinook Salmon analysis.") |> 
  kable_styling()
```

```{r edf-coef, eval = T}
mod_list <-
  crossing(model = c("SAR",
                   "Returns/Spawner"),
         returns = c("Total",
                     "Adult")) |> 
  arrange(desc(model),
          desc(returns)) |> 
  mutate(mod = list(gam_mod_2a,
                    gam_mod_2b,
                    gam_mod_2c,
                    gam_mod_2d))

mod_list |> 
  mutate(edf = map(mod,
                   .f = function(x) {
                     broom::tidy(x,
                                 parametric = F)
                   })) |> 
  select(-mod) |> 
  unnest(edf) |>
  mutate(sig = case_when(between(p.value, 0.01, 0.05) ~ "*",
                         between(p.value, 0.001, 0.01) ~ "**",
                         p.value < 0.001 ~ "***",
                         .default = NA_character_)) |> 
  clean_names("title") |> 
  kbl(digits = 3,
      booktabs = T,
      caption = "Effective degrees of freedom and statistical significance tests for the total and adult-only SAR and returns/spawner GAMs.") |> 
  kable_styling()

```

```{r sar-marg-plots}
colorspace_palette = c("dark3",
                       "set2",
                       "cold",
                       "harmonic",
                       "dynamic")[3]

length_p1 <-
  predict_gam(gam_mod_2a,
              length_out = 50,
              series = "mean_smolt_length",
              tran_fun = inv.logit) |>
  rename(sar = `cbind(suc_w_jacks, number_smolts - suc_w_jacks)`) |> 
  mutate(model = "Total") |> 
  bind_rows(predict_gam(gam_mod_2b,
                        length_out = 50,
                        series = "mean_smolt_length",
                        tran_fun = inv.logit) |> 
              rename(sar = `cbind(suc_wo_jacks, number_smolts - suc_wo_jacks)`) |> 
              mutate(model = "Adult")) |> 
  ggplot(aes(x = mean_smolt_length,
             y = sar,
             linetype = model,
             color = model,
             fill = model)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              color = NA,
              alpha = 0.3) +
  geom_line(linewidth = 1) +
  geom_rug(data = mod_df_2,
           aes(y = NULL,
               linetype = NULL,
               color = NULL,
               fill = NULL)) +
  # geom_point(data = mod_df_2,
  #            shape = 1) +
  # scale_y_continuous(limits = c(0, 0.08)) +
  scale_linetype_manual(values = c("Adult" = 1,
                                   "Total" = 2),
                        name = "Model") +
  scale_color_discrete_qualitative(palette = colorspace_palette,
                                   name = "Model") +
  scale_fill_discrete_qualitative(palette = colorspace_palette,
                                   name = "Model") +
  # scale_color_discrete_sequential(palette = "Grays",
  #                                 name = "Model",
  #                                 l1 = 30,
  #                                 l2 = 60) +
  # scale_fill_discrete_sequential(palette = "Grays",
  #                                name = "Model",
  #                                l1 = 30,
  #                                l2 = 60) +
  # theme(legend.postion = "bottom") +
  # scale_y_continuous(limits = c(0, 0.1)) +
  # coord_cartesian(ylim = c(0, 0.2)) +
  labs(y = "SAR",
       x = "Mean smolt length (mm)")

length_p2 <-
  predict_gam(gam_mod_2c,
              length_out = 50,
              series = "mean_smolt_length",
              tran_fun = exp) |> 
  rename(rps = total_rps) |> 
  mutate(model = "Total") |> 
  bind_rows(predict_gam(gam_mod_2d,
                        length_out = 50,
                        series = "mean_smolt_length",
                        tran_fun = exp) |> 
              rename(rps = adult_rps) |> 
              mutate(model = "Adult")) |> 
  ggplot(aes(x = mean_smolt_length,
             y = rps,
             linetype = model,
             color = model,
             fill = model)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              color = NA,
              alpha = 0.3) +
  geom_line(linewidth = 1) +
  geom_rug(data = mod_df_2,
           aes(y = NULL,
               linetype = NULL,
               color = NULL,
               fill = NULL)) +
  scale_color_discrete_qualitative(palette = colorspace_palette,
                                   name = "Model") +
  scale_fill_discrete_qualitative(palette = colorspace_palette,
                                  name = "Model") +  
  scale_linetype_manual(values = c("Adult" = 1,
                                   "Total" = 2),
                        name = "Model") +
  labs(y = "Returns /\nSpawner",
       x = "Mean smolt length (mm)")


phos_p1 <-
  predict_gam(gam_mod_2a,
              length_out = 50,
              series = "phos",
              tran_fun = inv.logit) |>
  rename(sar = `cbind(suc_w_jacks, number_smolts - suc_w_jacks)`) |> 
  mutate(model = "Total") |> 
  bind_rows(predict_gam(gam_mod_2b,
                        length_out = 50,
                        series = "phos",
                        tran_fun = inv.logit) |> 
              rename(sar = `cbind(suc_wo_jacks, number_smolts - suc_wo_jacks)`) |> 
              mutate(model = "Adult")) |> 
  ggplot(aes(x = phos,
             y = sar,
             linetype = model,
             color = model,
             fill = model)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              color = NA,
              alpha = 0.3) +
  geom_line(linewidth = 1) +
  geom_rug(data = mod_df_2,
           aes(y = NULL,
               linetype = NULL,
               color = NULL,
               fill = NULL)) +
  scale_color_discrete_qualitative(palette = colorspace_palette,
                                   name = "Model") +
  scale_fill_discrete_qualitative(palette = colorspace_palette,
                                  name = "Model") +  
  scale_linetype_manual(values = c("Adult" = 1,
                                   "Total" = 2),
                        name = "Model") +
  labs(y = "SAR",
       x = "pHOS")

phos_p2 <-
  predict_gam(gam_mod_2c,
              length_out = 50,
              series = "phos",
              tran_fun = exp) |> 
  rename(rps = total_rps) |> 
  mutate(model = "Total") |> 
  bind_rows(predict_gam(gam_mod_2d,
                        length_out = 50,
                        series = "phos",
                        tran_fun = exp) |>
              rename(rps = adult_rps) |> 
              mutate(model = "Adult")) |> 
  ggplot(aes(x = phos,
             y = rps,
             linetype = model,
             color = model,
             fill = model)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              color = NA,
              alpha = 0.3) +
  geom_line(linewidth = 1) +
  geom_rug(data = mod_df_2,
           aes(y = NULL,
               linetype = NULL,
               color = NULL,
               fill = NULL)) +
  scale_color_discrete_qualitative(palette = colorspace_palette,
                                   name = "Model") +
  scale_fill_discrete_qualitative(palette = colorspace_palette,
                                  name = "Model") +  
  scale_linetype_manual(values = c("Adult" = 1,
                                   "Total" = 2),
                        name = "Model") +
  labs(y = "Returns /\nSpawner",
       x = "pHOS")


by_p1 <-
  predict_gam(gam_mod_2a,
              length_out = diff(range(mod_df_2$brood_yr)),
              series = "brood_yr",
              tran_fun = inv.logit) |>
  rename(sar = `cbind(suc_w_jacks, number_smolts - suc_w_jacks)`) |> 
  mutate(model = "Total") |> 
  bind_rows(predict_gam(gam_mod_2b,
                        length_out = diff(range(mod_df_2$brood_yr)),
                        series = "brood_yr",
                        tran_fun = inv.logit) |> 
              rename(sar = `cbind(suc_wo_jacks, number_smolts - suc_wo_jacks)`) |> 
              mutate(model = "Adult")) |> 
  ggplot(aes(x = brood_yr,
             y = sar,
             linetype = model,
             color = model,
             fill = model)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              color = NA,
              alpha = 0.3) +
  geom_point() +
  geom_line() +
  scale_color_discrete_qualitative(palette = colorspace_palette,
                                   name = "Model") +
  scale_fill_discrete_qualitative(palette = colorspace_palette,
                                  name = "Model") +  
  scale_linetype_manual(values = c("Adult" = 1,
                                   "Total" = 2),
                        name = "Model") +
  labs(y = "SAR",
       x = "Brood Year")


by_p2 <-
  predict_gam(gam_mod_2c,
            length_out = diff(range(mod_df_2$brood_yr)),
            series = "brood_yr",
            tran_fun = exp) |>
  rename(rps = total_rps) |> 
  mutate(model = "Total") |> 
  bind_rows(predict_gam(gam_mod_2d,
                        length_out = diff(range(mod_df_2$brood_yr)),
                        series = "brood_yr",
                        tran_fun = exp) |>
              rename(rps = adult_rps) |> 
              mutate(model = "Adult")) |> 
  ggplot(aes(x = brood_yr,
             y = rps,
             linetype = model,
             color = model,
             fill = model)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              color = NA,
              alpha = 0.3) +
  geom_point() +
  geom_line() +
  scale_color_discrete_qualitative(palette = colorspace_palette,
                                 name = "Model") +
  scale_fill_discrete_qualitative(palette = colorspace_palette,
                                name = "Model") +
  scale_linetype_manual(values = c("Adult" = 1,
                                   "Total" = 2),
                        name = "Model") +
  labs(y = "Returns /\nSpawner",
       x = "Brood Year")
```

```{r ricker-plots}
rs_rick_p1 <-
  predict_gam(gam_mod_2c,
              series = "spawners",
              values = list(spawners = seq(0, max(ret_capacity$spawners, mod_df_2$spawners) + 200, by = 5)),
              tran_fun = exp) |>
  rename(rps = total_rps) |> 
  mutate(model = "Total") |> 
  bind_rows(predict_gam(gam_mod_2d,
                        series = "spawners",
                        values = list(spawners = seq(0, max(ret_capacity$spawners, mod_df_2$spawners) + 200, by = 5)),
                        tran_fun = exp) |> 
              rename(rps = adult_rps) |> 
              mutate(model = "Adult")) |> 
  mutate(recruits = rps * spawners,
         across(ends_with("ci"),
                ~ . * spawners)) |>
  ggplot(aes(x = spawners,
             y = recruits,
             linetype = model,
             color = model,
             fill = model)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              color = NA,
              alpha = 0.3) +
  geom_line(linewidth = 2) +
  geom_vline(xintercept = ret_capacity$spawners,
             linetype = 2,
             color = "black") +
  geom_rug(data = mod_df_2,
           aes(y = NULL,
               linetype = NULL,
               color = NULL,
               fill = NULL)) +
  scale_color_discrete_qualitative(palette = colorspace_palette,
                                   name = "Model") +
  scale_fill_discrete_qualitative(palette = colorspace_palette,
                                  name = "Model") +  
  scale_linetype_manual(values = c("Adult" = 1,
                                   "Total" = 2),
                        name = "Model") +
  labs(x = "Spawners",
       y = "Returns")


rs_rick_p2 <-
  predict_gam(gam_mod_2c,
              series = "spawners",
              values = list(spawners = seq(0, max(ret_capacity$spawners, mod_df_2$spawners) + 200, by = 5)),
              tran_fun = exp) |>
  rename(rps = total_rps) |> 
  mutate(model = "Total") |> 
  bind_rows(predict_gam(gam_mod_2d,
                        series = "spawners",
                        values = list(spawners = seq(0, max(ret_capacity$spawners, mod_df_2$spawners) + 200, by = 5)),
                        tran_fun = exp) |> 
              rename(rps = adult_rps) |> 
              mutate(model = "Adult")) |> 
  ggplot(aes(x = spawners,
             y = rps,
             linetype = model,
             color = model,
             fill = model)) + 
  geom_ribbon(aes(ymin = lower_ci,
                  ymax = upper_ci),
              color = NA,
              alpha = 0.3) +
  geom_line(linewidth = 1.5) +
  geom_rug(data = mod_df_2,
           aes(y = NULL,
               linetype = NULL,
               color = NULL,
               fill = NULL)) +
  scale_color_discrete_qualitative(palette = colorspace_palette,
                                   name = "Model") +
  scale_fill_discrete_qualitative(palette = colorspace_palette,
                                  name = "Model") +  
  scale_linetype_manual(values = c("Adult" = 1,
                                   "Total" = 2),
                        name = "Model") +
  labs(x = "Spawners",
       y = "Returns / Spawner")
  
```

The estimated Ricker curve of R/S, with the negative relationship of spawners on R/S is shown in Figure \@ref(fig:rec-marg-spwn), while Figure\@ref(fig:rec-marg-all) shows the marginal effect of smolt length, pHOS, and brood year on the various recruitment metrics. The estimated maximum returns (Figure \@ref(fig:rec-marg-spwn)A) are `r round(ret_capacity$returns[ret_capacity$model == "total"])` total returns and `r round(ret_capacity$returns[ret_capacity$model == "adult"])` adult returns, which occur when there are `r round(ret_capacity$spawners[ret_capacity$model == "total"])` and `r round(ret_capacity$spawners[ret_capacity$model == "adult"])` spawners respectively in the Tucannon River. Mean smolt length appears to have a positive association with SAR, but a negligible one with R/S. On the other hand, pHOS shows a negative association with SAR, and a non-linear but not significant relationship with R/S. The smoothed spline for brood year shows a few periods with higher SAR and R/S compared with other periods in the time-series.

```{r rec-marg-spwn, fig.height=3, fig.cap = "Ricker curves depicting the effect of spawner abundance on expected returns, colored by whether returns include total returns or only adults. A shows the predicted Ricker curve with vertical black dashed lines depicting the estimated number of spawners that result in the maximum returns / spawners for each model. B shows the linearized Ricker curve for the number of spawners vs the expected returns/spawner." }

ggarrange(rs_rick_p1,
          rs_rick_p2,
          ncol = 2,
          nrow = 1,
          labels = "AUTO",
          common.legend = T,
          legend = "bottom")
```

```{r rec-marg-all, fig.height=7, fig.cap = "Marginal effects of SAR (left column) and recruits/spawner (right column) models, colored by whether the response included total returns or only adults. The different rows show the marginal effect of mean smolt length (top), pHOS (middle), and brood year (bottom)."}

ggarrange(length_p1,
          length_p2,
          phos_p1,
          phos_p2,
          by_p1,
          by_p2,
          ncol = 2,
          nrow = 3,
          labels = "AUTO",
          common.legend = T,
          legend = "bottom")

```

<!-- # Discussion -->

<!-- Our chosen covariates were able to explain much of the observed variation in smolts/redd, SARs and returns/spawner (Table \@ref(tab:r2-tab)). However, we did include a flexible spline on emigration or brood year which allows a single covariate to explain a lot of otherwise unexplained variability. Even so, the marginal effects of other covariates provide useful ecological insight into this population.  -->

<!-- In the smolts/redd and both returns/spawner models, we assumed a linearized Ricker relationship between the productivity parameters and the number of redds or spawners. In all three models, there was a statistically significant negative relationship between redds or spawners and the productivity parameter (Tables \@ref(tab:sr-coef) and \@ref(tab:rec-spwn-coeff)). The negative impact of redds on smolts/redd indicates that this population is subject to density dependence somewhere between the egg and smolt lifestages (Figure \@ref(fig:prod-marg) A). In other words, juvenile rearing capacity may be a bottleneck for this population, although the estimated maximum capacity for smolts was never reached during our observed time series. There is also a clear density dependence in the returns/spawner models (Figure \@ref(fig:rec-marg-spwn)), which could also be in the freshwater life stage, or further stages in these fishess life history. ***Worth stating that most scientists assume infinite capacity in the ocean (although that may be changing with so many pink salmon)? Would need a citation.***  -->

<!-- The mean redd river kilometer shows a very weak relationship with smolts/redd, with a slight peak near river kilometer 59 where the weir is situated (Figure \@ref(fig:prod-marg) B). This could imply that the weir is having an impact [@Wilson2024]. The shape of the marginal effect of SD of redd rkm (Figure \@ref(fig:prod-marg) C) suggests that when redds are tightly clustered (i.e. low SD of redd rkm) productivity is lower, perhaps indicating local density dependence.  -->

<!-- The marginal effect of emigration year shows a fairly steady decline throughout the time-series (Figure \@ref(fig:prod-marg) D). This covariate captures underlying trends that aren't explained by the other covariates in the model, suggesting something not in our analysis may be negatively impacting the productivity of Tucannon Spring Chinook. -->

<!-- The marginal effect of pHOS indicates that higher levels of pHOS lead to higher productivity, although when hatchery origin spawners are made up of a higher proportion of out-of-basin hatchery strays, that effect is dampened (Figure \@ref(fig:prod-marg) E). However, that positive relationship between pHOS and productivity could be an erroneous conclusion. If hatchery produced smolts are part of the overall smolt number, and the number of hatchery releases are tied in any way to pHOS, then increased levels of pHOS could artificially inflate the number of smolts (since hatchery smolts wouldn't necessarily undergo the same density dependent survival processes of in-river rearing smolts) and therefore inflate the number of smolts/redd. ***Michael, can you confirm whether this is or is not the case? Are smolts at the screw trap wanded for CWTs, and if so are they ignored in the total smolt abundance estimate?*** -->

<!-- Alternatively, part of the story might depend on when fish are emigrating past the rotary screw trap, and therefore when they are counted as "smolts". If, during years with higher pHOS, more fish spawn in the lower river (where the habitat is worse), more of those juvenile fish may be forced to emigrate at an earlier age and smaller size (fall vs. spring?). This could lead to higher number of emigrants past the trap overall (therefore more smolts/redd), but those early migrants may not survive well further downstream. Another possible ecological mechanism is that progeny of hatchery fish may survive just fine as juveniles, but have much lower fitness at later life stages. For example, their genetics may lead them to feed copiously as juveniles, growing larger and doing well in the stream rearing environment, but they perform poorer at avoiding predation or finding food in the mainstem Columbia or Pacific Ocean compared to the progeny of wild parents. -->

<!-- In fact, this is borne out when looking at the SAR results. High levels of pHOS are associated with low SARs (Figure \@ref(fig:rec-marg-all), C), although that effect was not statistically significant (p-values = `r round(summary(gam_mod_2a)$s.table[2, 4], 3)` and `r round(summary(gam_mod_2b)$s.table[2, 4], 3)`. This association was corroborated by the 2017 Fish Passage Center's analysis of Tucannon Spring Chinook PIT tag data, when they found that SARs (release - BOA) during 2006-2017 were lower for hatchery fish compared to natural origin fish. So higher pHOS may result in more smolts/redd, but those smolts survive at a lower rate to adulthood, therefore leading to lower returns. The effect of pHOS on returns/spawner was neglible (Figure \@ref(fig:rec-marg-all), D).  -->

<!-- Meanwhile, a larger mean smolt length is associated with higher SARs, but has no association with returns/spawner (Figure \@ref(fig:rec-marg-all), A and B), although the effect on returns/spawner has a lot of uncertainty associated with it. ***It may be worth trying to break this down further by emigration season, or by using the mean date of emigration, if in fact the current smolt estimates are the sum of fall and spring emigrants.*** -->

<!-- Finally, the marginal effects of brood year on SARs and returns/spawner could be a proxy for shared ocean conditions by each brood year (Figure \@ref(fig:rec-marg-all), E and F).  -->

<!-- Analyses like these can find covariates that are strongly associated with productivity and recruitment metrics, but to more fully understand the effects we suggest building a life cycle model, perhaps an integrated population model (IPM) where these covariates can be allowed to impact specific life stages at specific times. However, current IPM structures cannot account for the spatial distribution of redds and would need to be extended. Such an endeavor is beyond the scope of this paper, but appears ripe for future research.  -->

# References
